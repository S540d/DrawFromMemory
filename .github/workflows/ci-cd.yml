name: CI/CD - Automated Quality Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Security: Explicitly set minimal permissions
permissions:
  contents: read

jobs:
  # ============================================================================
  # JOB 1: Code Quality & Linting
  # ============================================================================
  code-quality:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for console.log in production code
        run: |
          echo "Checking for console.log statements..."
          if grep -r "console\.log\|console\.debug" app/ components/ --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "âŒ ERROR: Found console.log/debug in production code!"
            exit 1
          else
            echo "âœ… No console.log found"
          fi

      - name: Check for Web APIs without Platform check
        run: |
          echo "Checking for unsafe Web API usage..."
          # Check for window.* without Platform.OS check
          if grep -r "window\." app/ components/ --exclude-dir=node_modules 2>/dev/null | grep -v "Platform.OS === 'web'" | grep -v "// platform-safe"; then
            echo "âŒ ERROR: Found window.* without Platform.OS check!"
            echo "Add 'Platform.OS === web' check or // platform-safe comment"
            exit 1
          fi

          # Check for localStorage without Platform.OS check
          if grep -r "localStorage\." app/ components/ --exclude-dir=node_modules 2>/dev/null | grep -v "Platform.OS === 'web'" | grep -v "// platform-safe"; then
            echo "âŒ ERROR: Found localStorage without Platform.OS check!"
            echo "Use AsyncStorage for mobile or add Platform.OS check"
            exit 1
          fi

          echo "âœ… All Web APIs are platform-safe"

      - name: Check for direct AsyncStorage imports
        run: |
          echo "Checking AsyncStorage usage..."
          # Ensure AsyncStorage is used for mobile, not localStorage
          if grep -r "@react-native-async-storage/async-storage" app/ components/ --exclude-dir=node_modules 2>/dev/null; then
            echo "âœ… AsyncStorage is properly used"
          fi

      - name: TypeScript Type Check
        run: npx tsc --noEmit || true

  # ============================================================================
  # JOB 2: Cross-Platform Build Tests
  # ============================================================================
  build-web:
    name: ðŸŒ Build Web
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Web
        run: npm run build:web

      - name: Check bundle size
        run: |
          if [ -d "dist" ]; then
            SIZE=$(du -sh dist | cut -f1)
            echo "ðŸ“¦ Bundle size: $SIZE"
          fi

      - name: Upload Web artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: web-build
          path: dist/
          retention-days: 7

  # ============================================================================
  # JOB 3: Platform Compatibility Checks (Expo Managed)
  # ============================================================================
  platform-checks:
    name: ðŸ”§ Platform Compatibility
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          echo "Checking version numbers..."

          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          APP_JSON_VERSION=$(node -p "require('./app.json').expo.version")

          echo "package.json: $PACKAGE_VERSION"
          echo "app.json: $APP_JSON_VERSION"

          if [ "$PACKAGE_VERSION" != "$APP_JSON_VERSION" ]; then
            echo "âŒ ERROR: Version mismatch!"
            echo "All versions must be identical."
            exit 1
          fi

          echo "âœ… All versions are consistent"

  # ============================================================================
  # JOB 4: Security & Dependencies
  # ============================================================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

      - name: Check for sensitive data
        run: |
          echo "Checking for sensitive data..."

          # Check for potential secrets
          if grep -ri "password\s*=\|api_key\s*=\|secret\s*=" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" 2>/dev/null; then
            echo "âš ï¸  WARNING: Potential sensitive data found!"
          else
            echo "âœ… No sensitive data found"
          fi

  # ============================================================================
  # JOB 5: Release Readiness Report
  # ============================================================================
  release-checklist:
    name: ðŸ“‹ Release Readiness Report
    runs-on: ubuntu-latest
    needs: [code-quality, build-web, platform-checks]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Generate Release Report
        run: |
          echo "# ðŸš€ Release Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Automated Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality & Linting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Web Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Platform Compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version Consistency" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Manual Checks Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Before deploying, manually verify:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test app with Expo Go on physical device" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test all features in web browser" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test game mechanics and drawing" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Settings persist correctly" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Release notes written" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $(node -p "require('./package.json').version")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
