const fs = require('fs');
const path = require('path');

const distPath = path.join(__dirname, '..', 'dist');
const baseUrl = '/DrawFromMemory';

console.log('ðŸ”§ Starting post-build processing for expo-router + GitHub Pages...');

// Get all HTML files generated by expo-router static rendering
const htmlFiles = fs.readdirSync(distPath)
  .filter(file => file.endsWith('.html'))
  .map(file => path.join(distPath, file));

console.log(`ðŸ“„ Found ${htmlFiles.length} HTML files to process`);

// Also need to update the JavaScript bundle to use correct base path
const jsFiles = fs.readdirSync(path.join(distPath, '_expo/static/js/web'))
  .filter(file => file.startsWith('entry-') && file.endsWith('.js'))
  .map(file => path.join(distPath, '_expo/static/js/web', file));

htmlFiles.forEach(filePath => {
  const fileName = path.basename(filePath);
  let html = fs.readFileSync(filePath, 'utf8');

  // Rewrite paths for GitHub Pages subpath
  // Match href="/..." but not href="//" (protocol-relative URLs)
  html = html.replace(/href="\/(?!\/)/g, `href="${baseUrl}/`);
  html = html.replace(/src="\/(?!\/)/g, `src="${baseUrl}/`);

  // Fix title if empty (expo-router sometimes generates empty titles)
  if (html.includes('<title data-rh="true"></title>') || html.includes('<title></title>')) {
    html = html.replace(
      /<title[^>]*><\/title>/,
      '<title>Merke und Male - GedÃ¤chtnistraining</title>'
    );
  }

  fs.writeFileSync(filePath, html);
  console.log(`  âœ“ Processed ${fileName}`);
});

// Update JavaScript bundle to handle basePath in router
jsFiles.forEach(filePath => {
  const fileName = path.basename(filePath);
  let js = fs.readFileSync(filePath, 'utf8');

  // Replace router base path configuration
  // This ensures client-side navigation works with the subpath
  js = js.replace(
    /location\.pathname/g,
    `location.pathname.replace('${baseUrl}', '')`
  );

  fs.writeFileSync(filePath, js);
  console.log(`  âœ“ Updated ${fileName} for subpath routing`);
});

// For SPA mode: Create 404.html that mirrors index.html for GitHub Pages routing
const indexPath = path.join(distPath, 'index.html');
const notFoundPath = path.join(distPath, '404.html');
if (fs.existsSync(indexPath) && !fs.existsSync(notFoundPath)) {
  fs.copyFileSync(indexPath, notFoundPath);
  console.log('  âœ“ Created 404.html for SPA routing');
}

console.log('âœ… Post-build processing complete!');
console.log(`   Updated all paths with baseUrl: ${baseUrl}`);
