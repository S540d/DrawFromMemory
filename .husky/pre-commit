#!/usr/bin/env sh
echo "üîç Running pre-commit checks..."

# Check for console.log in staged files
echo "Checking for console.log statements..."
if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -n "console\.log\|console\.debug" 2>/dev/null; then
  echo "‚ùå ERROR: Found console.log/debug in staged files!"
  echo "Please remove debug statements before committing."
  exit 1
fi

# Check for Web APIs without Platform.OS check
echo "Checking for unsafe Web API usage..."
if git diff --cached --name-only | grep -E '\.(ts|tsx)$' | xargs grep -n "window\." 2>/dev/null | grep -v "Platform.OS === 'web'" | grep -v "// platform-safe"; then
  echo "‚ùå ERROR: Found window.* without Platform.OS check!"
  echo "Add 'Platform.OS === \"web\"' check or // platform-safe comment"
  exit 1
fi

if git diff --cached --name-only | grep -E '\.(ts|tsx)$' | xargs grep -n "localStorage\." 2>/dev/null | grep -v "Platform.OS === 'web'" | grep -v "// platform-safe"; then
  echo "‚ùå ERROR: Found localStorage without Platform.OS check!"
  echo "Use AsyncStorage for mobile or add Platform.OS check"
  exit 1
fi

# Check version consistency if package.json or app.json changed
if git diff --cached --name-only | grep -E "(package\.json|app\.json|App\.tsx|build\.gradle\.kts)" >/dev/null; then
  echo "Checking version consistency..."

  PACKAGE_VERSION=$(node -p "require('./package.json').version" 2>/dev/null)
  APP_JSON_VERSION=$(node -p "require('./app.json').expo.version" 2>/dev/null)

  if [ "$PACKAGE_VERSION" != "$APP_JSON_VERSION" ]; then
    echo "‚ùå ERROR: Version mismatch between package.json and app.json!"
    echo "package.json: $PACKAGE_VERSION"
    echo "app.json: $APP_JSON_VERSION"
    exit 1
  fi
fi

echo "‚úÖ Pre-commit checks passed!"
